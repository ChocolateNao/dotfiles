#!/usr/bin/env bash

set -e

PACKAGE_MANAGER="{{- template "pkg_manager" . -}}"

source {{ joinPath .chezmoi.sourceDir "/helpers/logger.sh" | quote }}

log_info "Run pre-install script"
log_success "Package manager detected: ${PACKAGE_MANAGER}"

generate_ansible_playbook() {
    local TEMPLATE_PATH={{ joinPath .chezmoi.sourceDir "/dot_bootstrap/playbook_t.yml.tmpl" | quote }}
    local OUTPUT_PATH={{ joinPath .chezmoi.sourceDir "/dot_bootstrap/playbook.yml" | quote }}

    if [ -f $TEMPLATE_PATH ]; then
        log_info "Preparing ansible playbook"

        # On a fresh install chezmoi is saved in "/home/$USER/bin/chezmoi"
        {{ .chezmoi.executable }} execute-template < "$TEMPLATE_PATH" > "$OUTPUT_PATH"
    else
        log_error "Playbook template not found"
        exit 0
    fi
}

generate_ansible_playbook
